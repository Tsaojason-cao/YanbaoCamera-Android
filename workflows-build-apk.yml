name: ðŸš€ è‡ªåŠ¨æž„å»ºAPK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    # ========================================================================
    # 1. æ£€å‡ºä»£ç 
    # ========================================================================
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ========================================================================
    # 2. è®¾ç½®JavaçŽ¯å¢ƒ
    # ========================================================================
    - name: â˜• è®¾ç½®JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    # ========================================================================
    # 3. è®¾ç½®Android SDK
    # ========================================================================
    - name: ðŸ¤– è®¾ç½®Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools-version: 34.0.0
        ndk-version: 25.1.8937393

    # ========================================================================
    # 4. é…ç½®Gradle
    # ========================================================================
    - name: âš™ï¸ é…ç½®Gradleå±žæ€§
      run: |
        mkdir -p ~/.gradle
        cat > ~/.gradle/gradle.properties << EOF
        org.gradle.jvmargs=-Xmx4096m -XX:+UseG1GC
        org.gradle.parallel=true
        org.gradle.caching=true
        org.gradle.daemon=false
        android.useAndroidX=true
        android.enableJetifier=true
        EOF

    # ========================================================================
    # 5. åˆ›å»ºlocal.properties
    # ========================================================================
    - name: ðŸ“ åˆ›å»ºlocal.properties
      run: |
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        cat local.properties

    # ========================================================================
    # 6. æŽˆäºˆgradlewæ‰§è¡Œæƒé™
    # ========================================================================
    - name: ðŸ” æŽˆäºˆgradlewæ‰§è¡Œæƒé™
      run: chmod +x gradlew

    # ========================================================================
    # 7. æ¸…ç†æ—§æž„å»º
    # ========================================================================
    - name: ðŸ§¹ æ¸…ç†æ—§æž„å»º
      run: ./gradlew clean --no-daemon --stacktrace 2>&1 | tail -20

    # ========================================================================
    # 8. æž„å»ºDebug APK
    # ========================================================================
    - name: ðŸ”¨ æž„å»ºDebug APK
      id: build_debug
      continue-on-error: true
      run: |
        echo "å¼€å§‹æž„å»ºDebug APK..."
        ./gradlew assembleDebug \
          --no-daemon \
          --stacktrace \
          --info 2>&1 | tee debug-build.log
        
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "âœ… Debug APKæž„å»ºæˆåŠŸ"
          echo "debug_success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Debug APKæž„å»ºå¤±è´¥"
          echo "debug_success=false" >> $GITHUB_OUTPUT
        fi

    # ========================================================================
    # 9. å¦‚æžœDebugå¤±è´¥ï¼Œå°è¯•ä¿®å¤
    # ========================================================================
    - name: ðŸ”§ ä¿®å¤Debugæž„å»ºå¤±è´¥
      if: steps.build_debug.outputs.debug_success == 'false'
      run: |
        echo "å°è¯•ä¿®å¤Debugæž„å»º..."
        
        # æ¸…ç†ç¼“å­˜
        rm -rf ~/.gradle/caches
        rm -rf app/build
        
        # é‡æ–°åŒæ­¥
        ./gradlew sync --no-daemon
        
        # é‡æ–°æž„å»º
        ./gradlew assembleDebug \
          --no-daemon \
          --stacktrace 2>&1 | tail -30

    # ========================================================================
    # 10. æž„å»ºRelease APK
    # ========================================================================
    - name: ðŸ“¦ æž„å»ºRelease APK
      id: build_release
      continue-on-error: true
      run: |
        echo "å¼€å§‹æž„å»ºRelease APK..."
        ./gradlew assembleRelease \
          --no-daemon \
          --stacktrace \
          --info 2>&1 | tee release-build.log
        
        if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          echo "âœ… Release APKæž„å»ºæˆåŠŸ"
          echo "release_success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Release APKæž„å»ºå¤±è´¥"
          echo "release_success=false" >> $GITHUB_OUTPUT
        fi

    # ========================================================================
    # 11. å¦‚æžœReleaseå¤±è´¥ï¼Œå°è¯•ä¿®å¤
    # ========================================================================
    - name: ðŸ”§ ä¿®å¤Releaseæž„å»ºå¤±è´¥
      if: steps.build_release.outputs.release_success == 'false'
      run: |
        echo "å°è¯•ä¿®å¤Releaseæž„å»º..."
        
        # æ¸…ç†ç¼“å­˜
        rm -rf ~/.gradle/caches
        rm -rf app/build
        
        # é‡æ–°åŒæ­¥
        ./gradlew sync --no-daemon
        
        # é‡æ–°æž„å»º
        ./gradlew assembleRelease \
          --no-daemon \
          --stacktrace 2>&1 | tail -30

    # ========================================================================
    # 12. æž„å»ºRelease Bundle
    # ========================================================================
    - name: ðŸ“¦ æž„å»ºRelease Bundle
      id: build_bundle
      continue-on-error: true
      run: |
        echo "å¼€å§‹æž„å»ºRelease Bundle..."
        ./gradlew bundleRelease \
          --no-daemon \
          --stacktrace 2>&1 | tee bundle-build.log
        
        if [ -f "app/build/outputs/bundle/release/app-release.aab" ]; then
          echo "âœ… Release Bundleæž„å»ºæˆåŠŸ"
          echo "bundle_success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Release Bundleæž„å»ºå¤±è´¥"
          echo "bundle_success=false" >> $GITHUB_OUTPUT
        fi

    # ========================================================================
    # 13. å¦‚æžœBundleå¤±è´¥ï¼Œå°è¯•ä¿®å¤
    # ========================================================================
    - name: ðŸ”§ ä¿®å¤Bundleæž„å»ºå¤±è´¥
      if: steps.build_bundle.outputs.bundle_success == 'false'
      run: |
        echo "å°è¯•ä¿®å¤Bundleæž„å»º..."
        
        # æ¸…ç†ç¼“å­˜
        rm -rf ~/.gradle/caches
        rm -rf app/build
        
        # é‡æ–°åŒæ­¥
        ./gradlew sync --no-daemon
        
        # é‡æ–°æž„å»º
        ./gradlew bundleRelease \
          --no-daemon \
          --stacktrace 2>&1 | tail -30

    # ========================================================================
    # 14. ä¸Šä¼ Debug APK
    # ========================================================================
    - name: ðŸ“¤ ä¸Šä¼ Debug APK
      if: success() || steps.build_debug.outputs.debug_success == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    # ========================================================================
    # 15. ä¸Šä¼ Release APK
    # ========================================================================
    - name: ðŸ“¤ ä¸Šä¼ Release APK
      if: success() || steps.build_release.outputs.release_success == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: app-release-apk
        path: app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 30

    # ========================================================================
    # 16. ä¸Šä¼ Release Bundle
    # ========================================================================
    - name: ðŸ“¤ ä¸Šä¼ Release Bundle
      if: success() || steps.build_bundle.outputs.bundle_success == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: app-release-bundle
        path: app/build/outputs/bundle/release/app-release.aab
        retention-days: 30

    # ========================================================================
    # 17. ä¸Šä¼ æž„å»ºæ—¥å¿—
    # ========================================================================
    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          debug-build.log
          release-build.log
          bundle-build.log
        retention-days: 7

    # ========================================================================
    # 18. ç”Ÿæˆæž„å»ºæŠ¥å‘Š
    # ========================================================================
    - name: ðŸ“Š ç”Ÿæˆæž„å»ºæŠ¥å‘Š
      if: always()
      run: |
        cat > BUILD_REPORT.md << 'EOF'
        # ðŸš€ é›å®AIç›¸æœºApp - è‡ªåŠ¨æž„å»ºæŠ¥å‘Š
        
        ## ðŸ“‹ æž„å»ºä¿¡æ¯
        - **æž„å»ºæ—¶é—´**: $(date)
        - **æž„å»ºåˆ†æ”¯**: ${{ github.ref }}
        - **æäº¤SHA**: ${{ github.sha }}
        - **è§¦å‘è€…**: ${{ github.actor }}
        - **è¿è¡ŒID**: ${{ github.run_id }}
        
        ## âœ… æž„å»ºç»“æžœ
        
        ### Debug APK
        - **çŠ¶æ€**: ${{ steps.build_debug.outcome }}
        - **æ–‡ä»¶**: app/build/outputs/apk/debug/app-debug.apk
        - **è¯´æ˜Ž**: å¯ç›´æŽ¥å®‰è£…åˆ°è®¾å¤‡æµ‹è¯•
        
        ### Release APK
        - **çŠ¶æ€**: ${{ steps.build_release.outcome }}
        - **æ–‡ä»¶**: app/build/outputs/apk/release/app-release-unsigned.apk
        - **è¯´æ˜Ž**: éœ€è¦ç­¾ååŽæ‰èƒ½å‘å¸ƒ
        
        ### Release Bundle
        - **çŠ¶æ€**: ${{ steps.build_bundle.outcome }}
        - **æ–‡ä»¶**: app/build/outputs/bundle/release/app-release.aab
        - **è¯´æ˜Ž**: ç”¨äºŽå‘å¸ƒåˆ°Google Play
        
        ## ðŸ“¦ Artifacts
        
        æ‰€æœ‰ç”Ÿæˆçš„APKå’Œæ—¥å¿—éƒ½å·²ä¸Šä¼ åˆ°GitHub Artifactsï¼Œå¯åœ¨Actionsé¡µé¢ä¸‹è½½ã€‚
        
        ## ðŸ”— ä¸‹è½½é“¾æŽ¥
        
        - Debug APK: æŸ¥çœ‹Artifactsä¸­çš„ `app-debug-apk`
        - Release APK: æŸ¥çœ‹Artifactsä¸­çš„ `app-release-apk`
        - Release Bundle: æŸ¥çœ‹Artifactsä¸­çš„ `app-release-bundle`
        - æž„å»ºæ—¥å¿—: æŸ¥çœ‹Artifactsä¸­çš„ `build-logs`
        
        ## ðŸ“ è¯´æ˜Ž
        
        - Debug APK: å¯ç›´æŽ¥å®‰è£…åˆ°è®¾å¤‡æµ‹è¯•
        - Release APK: éœ€è¦ç­¾ååŽæ‰èƒ½å‘å¸ƒ
        - Release Bundle: ç”¨äºŽå‘å¸ƒåˆ°Google Play
        
        ## ðŸŽ¯ ä¸‹ä¸€æ­¥
        
        1. **æµ‹è¯•Debug APK**
           ```bash
           adb install -r app-debug.apk
           ```
        
        2. **ç­¾åRelease APK**
           ```bash
           jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
             -keystore my-release-key.keystore \
             app-release-unsigned.apk my-key-alias
           ```
        
        3. **å¯¹é½Release APK**
           ```bash
           zipalign -v 4 app-release-unsigned.apk app-release.apk
           ```
        
        4. **å‘å¸ƒåˆ°Google Play**
           - ä¸Šä¼ app-release.aabæˆ–app-release.apk
           - å¡«å†™åº”ç”¨ä¿¡æ¯
           - æäº¤å®¡æ ¸
        
        EOF
        cat BUILD_REPORT.md

    # ========================================================================
    # 19. ä¸Šä¼ æž„å»ºæŠ¥å‘Š
    # ========================================================================
    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºæŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: BUILD_REPORT.md
        retention-days: 30

    # ========================================================================
    # 20. å‘å¸ƒRelease (ä»…åœ¨æ ‡ç­¾æŽ¨é€æ—¶)
    # ========================================================================
    - name: ðŸŽ‰ å‘å¸ƒRelease
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          app/build/outputs/apk/debug/app-debug.apk
          app/build/outputs/apk/release/app-release-unsigned.apk
          app/build/outputs/bundle/release/app-release.aab
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ========================================================================
    # 21. å‘é€æž„å»ºå®Œæˆé€šçŸ¥
    # ========================================================================
    - name: ðŸ“¢ æž„å»ºå®Œæˆ
      if: always()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ðŸŽ‰ æž„å»ºå®Œæˆï¼"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… Debug APK: ${{ steps.build_debug.outcome }}"
        echo "âœ… Release APK: ${{ steps.build_release.outcome }}"
        echo "âœ… Release Bundle: ${{ steps.build_bundle.outcome }}"
        echo ""
        echo "ðŸ“¦ æ‰€æœ‰Artifactså·²ä¸Šä¼ åˆ°GitHub Actions"
        echo "ðŸ“¥ è®¿é—®Actionsé¡µé¢ä¸‹è½½ç”Ÿæˆçš„APK"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
