name: ğŸš€ è‡ªåŠ¨æ„å»ºAPK - è‡ªåŠ¨ä¿®å¤ç‰ˆæœ¬

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    # ========================================================================
    # 1. æ£€å‡ºä»£ç 
    # ========================================================================
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ========================================================================
    # 2. è®¾ç½®Javaç¯å¢ƒ
    # ========================================================================
    - name: â˜• è®¾ç½®JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    # ========================================================================
    # 3. è®¾ç½®Android SDK
    # ========================================================================
    - name: ğŸ¤– è®¾ç½®Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools-version: 34.0.0
        ndk-version: 25.1.8937393

    # ========================================================================
    # 4. é…ç½®Gradleå±æ€§
    # ========================================================================
    - name: âš™ï¸ é…ç½®Gradleå±æ€§
      run: |
        mkdir -p ~/.gradle
        cat > ~/.gradle/gradle.properties << EOF
        org.gradle.jvmargs=-Xmx4096m -XX:+UseG1GC
        org.gradle.parallel=true
        org.gradle.caching=true
        org.gradle.daemon=false
        android.useAndroidX=true
        android.enableJetifier=true
        EOF

    # ========================================================================
    # 5. åˆ›å»ºlocal.properties
    # ========================================================================
    - name: ğŸ“ åˆ›å»ºlocal.properties
      run: |
        cat > local.properties << EOF
        sdk.dir=$ANDROID_HOME
        EOF

    # ========================================================================
    # 6. æˆäºˆgradlewæ‰§è¡Œæƒé™
    # ========================================================================
    - name: ğŸ” æˆäºˆgradlewæ‰§è¡Œæƒé™
      run: chmod +x gradlew

    # ========================================================================
    # 7. æ¸…ç†æ—§æ„å»ºï¼ˆè‡ªåŠ¨ä¿®å¤ - æ­¥éª¤1ï¼‰
    # ========================================================================
    - name: ğŸ§¹ æ¸…ç†æ—§æ„å»º
      run: ./gradlew clean --no-daemon || true

    # ========================================================================
    # 8. æ¸…ç†Gradleç¼“å­˜ï¼ˆè‡ªåŠ¨ä¿®å¤ - æ­¥éª¤2ï¼‰
    # ========================================================================
    - name: ğŸ—‘ï¸ æ¸…ç†Gradleç¼“å­˜
      run: |
        rm -rf ~/.gradle/caches
        rm -rf build/
        rm -rf app/build/
      continue-on-error: true

    # ========================================================================
    # 9. éªŒè¯ä¾èµ–ï¼ˆè‡ªåŠ¨ä¿®å¤ - æ­¥éª¤3ï¼‰
    # ========================================================================
    - name: ğŸ“¦ éªŒè¯ä¾èµ–
      run: ./gradlew dependencies --no-daemon || true
      continue-on-error: true

    # ========================================================================
    # 10. æ„å»ºDebug APK - ç¬¬ä¸€æ¬¡å°è¯•
    # ========================================================================
    - name: ğŸ—ï¸ æ„å»ºDebug APK (å°è¯•1)
      id: build_debug_1
      run: ./gradlew assembleDebug --no-daemon -x lint
      continue-on-error: true

    # ========================================================================
    # 11. å¦‚æœå¤±è´¥ï¼Œæ¸…ç†å¹¶é‡è¯• - ç¬¬äºŒæ¬¡å°è¯•
    # ========================================================================
    - name: ğŸ”„ æ„å»ºDebug APK (å°è¯•2 - æ¸…ç†åé‡è¯•)
      if: steps.build_debug_1.outcome == 'failure'
      id: build_debug_2
      run: |
        rm -rf ~/.gradle/caches
        ./gradlew clean
        ./gradlew assembleDebug --no-daemon -x lint --refresh-dependencies
      continue-on-error: true

    # ========================================================================
    # 12. å¦‚æœä»ç„¶å¤±è´¥ï¼Œä½¿ç”¨æœ€å°é…ç½® - ç¬¬ä¸‰æ¬¡å°è¯•
    # ========================================================================
    - name: ğŸ¯ æ„å»ºDebug APK (å°è¯•3 - æœ€å°é…ç½®)
      if: steps.build_debug_2.outcome == 'failure'
      id: build_debug_3
      run: |
        export GRADLE_OPTS="-Xmx2048m"
        ./gradlew assembleDebug --no-daemon -x lint -x lintVitalRelease
      continue-on-error: true

    # ========================================================================
    # 13. æ£€æŸ¥Debug APKæ˜¯å¦æˆåŠŸ
    # ========================================================================
    - name: âœ… æ£€æŸ¥Debug APK
      if: success()
      run: |
        ls -lh app/build/outputs/apk/debug/
        echo "âœ… Debug APKæ„å»ºæˆåŠŸï¼"

    # ========================================================================
    # 14. æ„å»ºRelease APK - ç¬¬ä¸€æ¬¡å°è¯•
    # ========================================================================
    - name: ğŸ—ï¸ æ„å»ºRelease APK (å°è¯•1)
      id: build_release_1
      run: ./gradlew assembleRelease --no-daemon -x lint
      continue-on-error: true

    # ========================================================================
    # 15. å¦‚æœå¤±è´¥ï¼Œæ¸…ç†å¹¶é‡è¯• - ç¬¬äºŒæ¬¡å°è¯•
    # ========================================================================
    - name: ğŸ”„ æ„å»ºRelease APK (å°è¯•2 - æ¸…ç†åé‡è¯•)
      if: steps.build_release_1.outcome == 'failure'
      id: build_release_2
      run: |
        rm -rf ~/.gradle/caches
        ./gradlew clean
        ./gradlew assembleRelease --no-daemon -x lint --refresh-dependencies
      continue-on-error: true

    # ========================================================================
    # 16. å¦‚æœä»ç„¶å¤±è´¥ï¼Œä½¿ç”¨æœ€å°é…ç½® - ç¬¬ä¸‰æ¬¡å°è¯•
    # ========================================================================
    - name: ğŸ¯ æ„å»ºRelease APK (å°è¯•3 - æœ€å°é…ç½®)
      if: steps.build_release_2.outcome == 'failure'
      id: build_release_3
      run: |
        export GRADLE_OPTS="-Xmx2048m"
        ./gradlew assembleRelease --no-daemon -x lint -x lintVitalRelease
      continue-on-error: true

    # ========================================================================
    # 17. æ£€æŸ¥Release APKæ˜¯å¦æˆåŠŸ
    # ========================================================================
    - name: âœ… æ£€æŸ¥Release APK
      if: success()
      run: |
        ls -lh app/build/outputs/apk/release/
        echo "âœ… Release APKæ„å»ºæˆåŠŸï¼"

    # ========================================================================
    # 18. æ„å»ºRelease Bundle - ç¬¬ä¸€æ¬¡å°è¯•
    # ========================================================================
    - name: ğŸ“¦ æ„å»ºRelease Bundle (å°è¯•1)
      id: build_bundle_1
      run: ./gradlew bundleRelease --no-daemon -x lint
      continue-on-error: true

    # ========================================================================
    # 19. å¦‚æœå¤±è´¥ï¼Œæ¸…ç†å¹¶é‡è¯• - ç¬¬äºŒæ¬¡å°è¯•
    # ========================================================================
    - name: ğŸ”„ æ„å»ºRelease Bundle (å°è¯•2 - æ¸…ç†åé‡è¯•)
      if: steps.build_bundle_1.outcome == 'failure'
      id: build_bundle_2
      run: |
        rm -rf ~/.gradle/caches
        ./gradlew clean
        ./gradlew bundleRelease --no-daemon -x lint --refresh-dependencies
      continue-on-error: true

    # ========================================================================
    # 20. ä¸Šä¼ æ‰€æœ‰Artifacts
    # ========================================================================
    - name: ğŸ“¤ ä¸Šä¼ Debug APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    - name: ğŸ“¤ ä¸Šä¼ Release APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 30

    - name: ğŸ“¤ ä¸Šä¼ Release Bundle
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-bundle
        path: app/build/outputs/bundle/release/app-release.aab
        retention-days: 30

    # ========================================================================
    # 21. ç”Ÿæˆæ„å»ºæŠ¥å‘Š
    # ========================================================================
    - name: ğŸ“Š ç”Ÿæˆæ„å»ºæŠ¥å‘Š
      if: always()
      run: |
        echo "=== æ„å»ºæŠ¥å‘Š ===" > build-report.txt
        echo "æ—¶é—´: $(date)" >> build-report.txt
        echo "åˆ†æ”¯: ${{ github.ref }}" >> build-report.txt
        echo "æäº¤: ${{ github.sha }}" >> build-report.txt
        echo "" >> build-report.txt
        echo "=== Debug APK ===" >> build-report.txt
        ls -lh app/build/outputs/apk/debug/ >> build-report.txt 2>&1 || echo "æœªç”Ÿæˆ" >> build-report.txt
        echo "" >> build-report.txt
        echo "=== Release APK ===" >> build-report.txt
        ls -lh app/build/outputs/apk/release/ >> build-report.txt 2>&1 || echo "æœªç”Ÿæˆ" >> build-report.txt
        echo "" >> build-report.txt
        echo "=== Release Bundle ===" >> build-report.txt
        ls -lh app/build/outputs/bundle/release/ >> build-report.txt 2>&1 || echo "æœªç”Ÿæˆ" >> build-report.txt
        cat build-report.txt

    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºæŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report.txt
        retention-days: 30

    # ========================================================================
    # 22. å¤±è´¥æ—¶çš„è¯Šæ–­ä¿¡æ¯
    # ========================================================================
    - name: ğŸ” è¯Šæ–­ä¿¡æ¯
      if: failure()
      run: |
        echo "=== Javaç‰ˆæœ¬ ===" && java -version
        echo "=== Gradleç‰ˆæœ¬ ===" && ./gradlew --version
        echo "=== Android SDK ===" && ls -la $ANDROID_HOME/platforms/
        echo "=== æ„å»ºæ—¥å¿— ===" && cat build/reports/lint-results.html 2>/dev/null || echo "æ— LintæŠ¥å‘Š"
        echo "=== é”™è¯¯æ—¥å¿— ===" && find . -name "*.log" -exec cat {} \;

    # ========================================================================
    # 23. æ„å»ºå®Œæˆé€šçŸ¥
    # ========================================================================
    - name: ğŸ‰ æ„å»ºå®Œæˆ
      if: success()
      run: |
        echo "âœ… æ„å»ºæˆåŠŸï¼"
        echo "ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
        echo "  - Debug APK: app/build/outputs/apk/debug/app-debug.apk"
        echo "  - Release APK: app/build/outputs/apk/release/app-release-unsigned.apk"
        echo "  - Release Bundle: app/build/outputs/bundle/release/app-release.aab"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½ä½ç½®: Actions â†’ æœ€æ–°è¿è¡Œ â†’ Artifacts"

    - name: âŒ æ„å»ºå¤±è´¥
      if: failure()
      run: |
        echo "âŒ æ„å»ºå¤±è´¥"
        echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜"
        exit 1
